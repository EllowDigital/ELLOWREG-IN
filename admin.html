<!-- VERSION: 5.3 - EMRS ADMIN OVERHAUL - 30 OCT 2025 -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - EMRS by EllowDigital</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #0a2540;
      --secondary-color: #1b3a73;
      --surface: rgba(255, 255, 255, 0.88);
      --text-muted: #6c757d;
      --danger: #dc3545;
    }

    body {
      background: radial-gradient(circle at top, #edf2f9 0%, #e0e7f1 45%, #d6deeb 100%);
      font-family:
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        "Helvetica Neue",
        Arial;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #1d2d50;
    }

    .navbar {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }

    .navbar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
    }

    .navbar .nav-link:hover,
    .navbar .nav-link:focus,
    .navbar .nav-link.active {
      color: #ffffff;
    }

    .center-container {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .page-title {
      font-size: 2.25rem;
      font-weight: 700;
    }

    .glass-card {
      background: var(--surface);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      box-shadow: 0 12px 50px rgba(31, 38, 135, 0.12);
    }

    .stats-card {
      padding: 1.5rem;
    }

    .stats-card-body {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stats-card-info {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      align-items: flex-start;
      text-align: left;
    }

    .widget-icon {
      font-size: 1.5rem;
      width: 52px;
      height: 52px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(10, 37, 64, 0.12);
      color: var(--primary-color);
      flex-shrink: 0;
    }

    .stat-label {
      font-size: 0.75rem;
      letter-spacing: 0.08rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .stat-value {
      font-size: 1.9rem;
      font-weight: 700;
    }

    .table thead {
      font-size: 0.78rem;
      letter-spacing: 0.04rem;
      text-transform: uppercase;
    }

    .table td {
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .table-responsive {
      position: relative;
    }

    .table-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      border-radius: 0.75rem;
    }

    .subtle-text {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .footer-credit {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .heart-blink {
      color: var(--danger);
      animation: heartbeat 1.5s infinite;
    }

    .section-heading {
      font-size: 1.35rem;
      font-weight: 700;
    }

    .overview-header p {
      max-width: 420px;
    }

    .search-input-group {
      max-width: 360px;
    }

    .actions-group {
      display: inline-flex;
      gap: 0.5rem;
    }

    .actions-group .btn {
      min-width: 2.5rem;
    }

    .system-status-wrapper {
      width: 100%;
      max-width: 640px;
      margin-left: auto;
      margin-right: auto;
    }

    .registrations-toolbar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .registrations-toolbar .toolbar-controls {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .registrations-toolbar .toolbar-controls .form-select {
      min-width: 90px;
    }

    .registrations-toolbar .toolbar-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: stretch;
      justify-content: flex-start;
    }

    .download-hint {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 0.9rem;
      background: rgba(10, 37, 64, 0.08);
      color: var(--primary-color);
    }

    .download-hint i {
      font-size: 1rem;
      margin-top: 0.1rem;
    }

    .download-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      color: var(--text-muted);
    }

    .download-meta .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: rgba(10, 37, 64, 0.12);
      color: var(--primary-color);
      font-weight: 600;
      font-size: 0.75rem;
      letter-spacing: 0.04rem;
      text-transform: uppercase;
    }

    @media (min-width: 992px) {
      .registrations-toolbar {
        flex-direction: column;
      }

      .registrations-toolbar .toolbar-controls {
        flex-direction: row;
        align-items: center;
        justify-content: flex-end;
        gap: 1rem;
      }

      .registrations-toolbar .toolbar-controls form {
        flex: 1 1 360px;
        max-width: 480px;
      }

      .registrations-toolbar .toolbar-actions {
        justify-content: flex-end;
      }
    }

    @keyframes heartbeat {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.2);
      }
    }

    @media (max-width: 991.98px) {
      .search-input-group {
        width: 100%;
      }

      .registrations-toolbar .toolbar-controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    @media (max-width: 767.98px) {
      .stats-card {
        text-align: center;
      }

      .stats-card-body {
        flex-direction: column;
        align-items: center;
      }

      .stats-card-info {
        align-items: center;
        text-align: center;
      }

      .widget-icon {
        margin: 0 auto;
      }

      .overview-header {
        justify-content: center;
        text-align: center;
      }

      .overview-header>div {
        width: 100%;
      }

      .overview-header p {
        margin-left: auto;
        margin-right: auto;
      }

      .actions-group {
        flex-direction: column;
        align-items: stretch;
      }

      .registrations-toolbar {
        gap: 1.25rem;
      }

      .registrations-toolbar .toolbar-actions {
        flex-direction: column;
        align-items: stretch;
      }
    }

    @media (max-width: 575.98px) {
      .page-title {
        font-size: 1.8rem;
      }

      .navbar .btn {
        width: 100%;
      }

      .stats-card {
        padding: 1.25rem;
      }

      .table thead {
        font-size: 0.7rem;
      }

      .table td {
        font-size: 0.85rem;
      }
    }
  </style>
</head>

<body>
  <div id="login-container" class="center-container">
    <div class="card shadow-sm border-0" style="max-width: 24rem">
      <div class="card-body p-4">
        <div class="text-center mb-4">
          <i class="fas fa-shield-alt fa-2x text-primary mb-3"></i>
          <h3 class="card-title mb-1">Admin Access</h3>
          <p class="text-muted small mb-0">
            Secure gateway to the EMRS control center
          </p>
        </div>
        <form id="loginForm">
          <div class="mb-3">
            <label for="passwordInput" class="form-label fw-semibold">Master Password</label>
            <input type="password" class="form-control form-control-lg" id="passwordInput" required />
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
              <span class="button-text">Unlock Dashboard</span>
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>
        <div id="loginError" class="alert alert-danger mt-3 d-none" role="alert"></div>
      </div>
    </div>
  </div>

  <div id="dashboard-container" class="d-none">
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#overview">
          <i class="fas fa-user-shield me-2"></i>EMRS Admin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar"
          aria-controls="adminNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="adminNavbar">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="#overview">Overview</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#system">System</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#registrations">Registrations</a>
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="text-light small" id="lastRefreshLabel">Awaiting data...</span>
            <button id="refreshDashboardBtn" class="btn btn-outline-light btn-sm">
              <span class="button-text"><i class="fas fa-rotate me-1"></i>Refresh</span>
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
            <button id="logoutBtn" class="btn btn-danger btn-sm">
              <i class="fas fa-sign-out-alt me-1"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <main class="container-xxl py-4">
      <section id="overview" class="mb-5">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4 overview-header">
          <div>
            <h1 class="page-title mb-1">Control Center</h1>
            <p class="text-muted mb-0">
              Monitor registrations, runtime health, and exports in real time.
            </p>
          </div>
        </div>
        <div class="row g-4">
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="glass-card stats-card h-100">
              <div class="stats-card-body">
                <div class="widget-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="stats-card-info">
                  <div class="stat-label">Total Registrations</div>
                  <div class="stat-value" id="totalRegCount">
                    <div class="spinner-border spinner-border-sm"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="glass-card stats-card h-100">
              <div class="stats-card-body">
                <div class="widget-icon">
                  <i class="fas fa-bolt"></i>
                </div>
                <div class="stats-card-info">
                  <div class="stat-label">Last 24 Hours</div>
                  <div class="stat-value" id="registrationsLast24Hours">
                    <div class="spinner-border spinner-border-sm"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="glass-card stats-card h-100">
              <div class="stats-card-body">
                <div class="widget-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stats-card-info">
                  <div class="stat-label">Last Registration</div>
                  <div class="stat-value fs-5" id="lastRegTime">
                    <div class="spinner-border spinner-border-sm"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="glass-card stats-card h-100">
              <div class="stats-card-body">
                <div class="widget-icon">
                  <i class="fas fa-user-check"></i>
                </div>
                <div class="stats-card-info">
                  <div class="stat-label">Checked In</div>
                  <div class="stat-value" id="checkedInCount">
                    <div class="spinner-border spinner-border-sm"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="system" class="mb-5">
        <div class="system-status-wrapper">
          <div class="glass-card p-4 h-100">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h2 class="section-heading mb-0">System Status</h2>
              <button id="checkStatusBtn" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-sync-alt me-1"></i>Refresh
              </button>
            </div>
            <p class="text-muted small">
              Live health indicators across core services powering the EMRS stack.
            </p>
            <ul class="list-group list-group-flush">
              <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                <span>
                  <i class="fas fa-database fa-fw me-2 text-primary"></i>
                  Database
                </span>
                <span id="status-database" class="badge bg-light text-dark">
                  <div class="spinner-border spinner-border-sm"></div>
                </span>
              </li>
              <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                <span>
                  <i class="fas fa-cloud fa-fw me-2 text-info"></i>
                  Cloudinary
                </span>
                <span id="status-cloudinary" class="badge bg-light text-dark">
                  <div class="spinner-border spinner-border-sm"></div>
                </span>
              </li>
              <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                <span>
                  <i class="fas fa-file-excel fa-fw me-2 text-success"></i>
                  Google Sheets
                </span>
                <span id="status-googleSheets" class="badge bg-light text-dark">
                  <div class="spinner-border spinner-border-sm"></div>
                </span>
              </li>
            </ul>
          </div>
        </div>
      </section>

      <section id="registrations" class="mb-5">
        <div class="glass-card p-4">
          <div class="registrations-toolbar mb-4">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
              <div>
                <h2 class="section-heading mb-1">Recent Registrations</h2>
                <p class="text-muted small mb-0">
                  Paginated roster of confirmed attendees in reverse chronological order.
                </p>
              </div>
              <div class="toolbar-controls ms-xl-auto">
                <form id="registrationsSearchForm" class="w-100">
                  <div class="input-group input-group-sm search-input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                    <input type="search" class="form-control" id="registrationsSearchInput"
                      placeholder="Search name, email, phone, or Reg ID" aria-label="Search registrations" />
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">Clear</button>
                  </div>
                </form>
                <div class="toolbar-actions">
                  <div class="d-flex align-items-center gap-2">
                    <label for="pageSizeSelect" class="small text-muted mb-0">Rows</label>
                    <select id="pageSizeSelect" class="form-select form-select-sm">
                      <option value="10" selected>10</option>
                      <option value="25">25</option>
                      <option value="50">50</option>
                    </select>
                  </div>
                  <button id="refreshTableBtn" class="btn btn-outline-primary btn-sm">
                    <span class="button-text"><i class="fas fa-sync-alt me-1"></i>Reload</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                  </button>
                  <div class="d-flex flex-column gap-1 align-items-stretch">
                    <button id="syncSheetsBtn" class="btn btn-outline-success">
                      <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                      <span class="button-text"><i class="fas fa-sync me-2"></i>Sync Sheets</span>
                    </button>
                    <div id="syncStatus" class="small text-muted"></div>
                  </div>
                  <div class="d-flex flex-column gap-1 align-items-stretch">
                    <button id="exportBtn" class="btn btn-success">
                      <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                      <span class="button-text"><i class="fas fa-file-excel me-2"></i>Download Excel</span>
                    </button>
                    <div id="exportStatus" class="small text-muted"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="download-meta small mt-2">
              <div class="download-hint">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Heads up:</strong> Allow pop-ups so the Excel download can start automatically.</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="chip"><i class="fas fa-clock"></i> Export</span>
                <span>Last download <span class="fw-semibold" id="lastExportTime">Never</span></span>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <div id="registrationsLoading" class="table-overlay d-none">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Reg ID</th>
                  <th scope="col">Name</th>
                  <th scope="col">Phone</th>
                  <th scope="col" class="d-none d-lg-table-cell">Email</th>
                  <th scope="col" class="d-none d-md-table-cell">City</th>
                  <th scope="col" class="d-none d-lg-table-cell">State</th>
                  <th scope="col">Registered</th>
                  <th scope="col">Check-In</th>
                  <th scope="col" class="text-end text-nowrap">Actions</th>
                </tr>
              </thead>
              <tbody id="registrationsTableBody">
                <tr>
                  <td colspan="9" class="text-center text-muted py-4">
                    Loading registrations...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="registrationsError" class="alert alert-danger mt-3 d-none" role="alert"></div>
          <div id="registrationsFeedback" class="alert alert-success mt-3 d-none" role="alert"></div>
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mt-3">
            <div class="text-muted small" id="paginationStatus">Showing 0 of 0</div>
            <div class="d-flex align-items-center gap-2">
              <button id="paginationPrev" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              <span class="small fw-semibold" id="paginationIndicator">1 / 1</span>
              <button id="paginationNext" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="modal fade" id="editRegistrationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Update Registration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="editRegistrationForm" novalidate>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-semibold">Registration ID</label>
                <input type="text" class="form-control" id="editRegistrationId" readonly />
              </div>
              <div class="mb-3">
                <label for="editNameInput" class="form-label fw-semibold">Full Name</label>
                <input type="text" class="form-control" id="editNameInput" required />
              </div>
              <div class="mb-3">
                <label for="editPhoneInput" class="form-label fw-semibold">Phone</label>
                <input type="tel" class="form-control" id="editPhoneInput" required />
              </div>
              <div class="mb-3">
                <label for="editEmailInput" class="form-label fw-semibold">Email</label>
                <input type="email" class="form-control" id="editEmailInput" />
              </div>
              <div class="row g-3">
                <div class="col-sm-6">
                  <label for="editCityInput" class="form-label fw-semibold">City</label>
                  <input type="text" class="form-control" id="editCityInput" />
                </div>
                <div class="col-sm-6">
                  <label for="editStateInput" class="form-label fw-semibold">State</label>
                  <input type="text" class="form-control" id="editStateInput" />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="editRegistrationSubmitBtn">
                <span class="button-text">Save Changes</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteRegistrationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Delete Registration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="deleteRegistrationForm">
            <div class="modal-body">
              <input type="hidden" id="deleteRegistrationId" />
              <p class="mb-0" id="deleteRegistrationSummary"></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">
                <span class="button-text">Delete</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-4 mt-auto">
    <p class="footer-credit mb-0">
      Made with <span class="heart-blink">&#10084;</span> by
      <a href="https://ellow.in/" target="_blank" class="fw-bold text-decoration-none text-muted">EllowDigital</a>
    </p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let ADMIN_SECRET_KEY = null;

      const DEFAULT_PAGE_SIZE = 10;
      const state = {
        currentPage: 1,
        totalPages: 1,
        totalRecords: 0,
        pageSize: DEFAULT_PAGE_SIZE,
        searchTerm: "",
        currentRecords: [],
      };

      const loginContainer = document.getElementById("login-container");
      const dashboardContainer = document.getElementById("dashboard-container");
      const loginForm = document.getElementById("loginForm");
      const loginBtn = document.getElementById("loginBtn");
      const passwordInput = document.getElementById("passwordInput");
      const loginError = document.getElementById("loginError");
      const refreshDashboardBtn = document.getElementById("refreshDashboardBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const lastRefreshLabel = document.getElementById("lastRefreshLabel");

      let totalRegCountEl,
        registrationsLast24HoursEl,
        lastRegTimeEl,
        checkedInCountEl,
        exportBtn,
        exportStatus,
        syncSheetsBtn,
        syncStatus,
        checkStatusBtn,
        lastExportTimeEl,
        pageSizeSelect,
        registrationsLoadingOverlay,
        registrationsTableBody,
        registrationsErrorEl,
        registrationsFeedbackEl,
        paginationStatusEl,
        paginationIndicatorEl,
        paginationPrevBtn,
        paginationNextBtn,
        refreshTableBtn,
        registrationsSearchForm,
        registrationsSearchInput,
        clearSearchBtn,
        editRegistrationForm,
        editRegistrationId,
        editNameInput,
        editPhoneInput,
        editEmailInput,
        editCityInput,
        editStateInput,
        editRegistrationSubmitBtn,
        deleteRegistrationForm,
        deleteRegistrationId,
        deleteRegistrationSummary,
        confirmDeleteBtn;

      let editModalInstance;
      let deleteModalInstance;

      const setButtonLoading = (btn, isLoading) => {
        if (!btn) return;
        const textEl = btn.querySelector(".button-text");
        const spinnerEl = btn.querySelector(".spinner-border");
        btn.disabled = isLoading;
        if (textEl) textEl.classList.toggle("d-none", isLoading);
        if (spinnerEl) spinnerEl.classList.toggle("d-none", !isLoading);
      };

      const updateLastRefreshLabel = () => {
        if (!lastRefreshLabel) return;
        lastRefreshLabel.textContent = `Updated ${new Date().toLocaleString("en-IN", {
          dateStyle: "medium",
          timeStyle: "short",
        })}`;
      };

      const displayLastExportTime = () => {
        if (!lastExportTimeEl) lastExportTimeEl = document.getElementById("lastExportTime");
        const lastExportTimestamp = localStorage.getItem("lastExportTimestamp");
        if (lastExportTimestamp) {
          const date = new Date(lastExportTimestamp);
          lastExportTimeEl.textContent = date.toLocaleString("en-IN", {
            dateStyle: "medium",
            timeStyle: "short",
          });
        } else {
          lastExportTimeEl.textContent = "Never";
        }
      };

      const setStatusIndicator = (elementId, status) => {
        const el = document.getElementById(elementId);
        if (!el) return;
        const config = {
          ok: { class: "bg-success text-white", text: "Operational" },
          error: { class: "bg-danger text-white", text: "Down" },
        };
        const current = config[status] || {
          class: "bg-warning text-dark",
          text: "Unknown",
        };
        el.className = `badge ${current.class} p-2`;
        el.textContent = current.text;
      };

      const escapeHtml = (unsafe) => {
        if (unsafe === undefined || unsafe === null) return "";
        return unsafe
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      };

      const formatDateTime = (value) => {
        if (!value) return "--";
        return new Date(value).toLocaleString("en-IN", {
          dateStyle: "medium",
          timeStyle: "short",
        });
      };

      const setTableLoading = (isLoading) => {
        if (registrationsLoadingOverlay) {
          registrationsLoadingOverlay.classList.toggle("d-none", !isLoading);
        }
        if (paginationPrevBtn) paginationPrevBtn.disabled = isLoading;
        if (paginationNextBtn) paginationNextBtn.disabled = isLoading;
      };

      const updatePaginationUI = () => {
        if (!paginationStatusEl || !paginationIndicatorEl) return;
        if (state.totalRecords === 0) {
          paginationStatusEl.textContent = "No registrations on record.";
        } else {
          const start = (state.currentPage - 1) * state.pageSize + 1;
          const end = Math.min(state.totalRecords, state.currentPage * state.pageSize);
          paginationStatusEl.textContent = `Showing ${start} - ${end} of ${state.totalRecords}`;
        }
        paginationIndicatorEl.textContent = `${state.currentPage} / ${state.totalPages}`;
        if (paginationPrevBtn) paginationPrevBtn.disabled = state.currentPage <= 1;
        if (paginationNextBtn) paginationNextBtn.disabled = state.currentPage >= state.totalPages;
      };

      const setFeedbackMessage = (variant, message) => {
        if (!registrationsFeedbackEl) return;
        registrationsFeedbackEl.className = `alert alert-${variant} mt-3`;
        registrationsFeedbackEl.textContent = message;
        registrationsFeedbackEl.classList.remove("d-none");
      };

      const clearFeedbackMessage = () => {
        if (!registrationsFeedbackEl) return;
        registrationsFeedbackEl.classList.add("d-none");
        registrationsFeedbackEl.textContent = "";
      };

      const syncSearchUI = () => {
        if (!clearSearchBtn) return;
        clearSearchBtn.disabled = state.searchTerm.length === 0;
      };

      const renderRegistrations = (records = []) => {
        if (!registrationsTableBody) return;
        if (!Array.isArray(records) || records.length === 0) {
          registrationsTableBody.innerHTML = `
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  No registrations found.
                </td>
              </tr>
            `;
          return;
        }

        const rowsHtml = records
          .map((entry) => {
            const registeredAt = formatDateTime(entry.timestamp);
            const checkInBadge = entry.checked_in_at
              ? `<span class="badge bg-success">Checked in</span><div class="subtle-text mt-1">${formatDateTime(entry.checked_in_at)}</div>`
              : '<span class="badge bg-warning text-dark">Pending</span>';
            const phoneCell = entry.phone
              ? `<a href="tel:${escapeHtml(entry.phone)}" class="text-decoration-none">${escapeHtml(entry.phone)}</a>`
              : "--";
            const emailCell = entry.email
              ? `<a href="mailto:${escapeHtml(entry.email)}" class="text-decoration-none">${escapeHtml(entry.email)}</a>`
              : "--";
            return `
                <tr>
                  <td class="fw-semibold">${escapeHtml(entry.registration_id) || "--"}</td>
                  <td>${escapeHtml(entry.name) || "--"}</td>
                  <td>${phoneCell}</td>
                  <td class="d-none d-lg-table-cell">${emailCell}</td>
                  <td class="d-none d-md-table-cell">${escapeHtml(entry.city) || "--"}</td>
                  <td class="d-none d-lg-table-cell">${escapeHtml(entry.state) || "--"}</td>
                  <td>${registeredAt}</td>
                  <td>${checkInBadge}</td>
                  <td class="text-end">
                    <div class="actions-group justify-content-end">
                      <button type="button" class="btn btn-outline-secondary btn-sm" data-action="edit-registration" data-registration="${escapeHtml(entry.registration_id || "")}">
                        <i class="fas fa-pen"></i>
                        <span class="visually-hidden">Edit</span>
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-sm" data-action="delete-registration" data-registration="${escapeHtml(entry.registration_id || "")}">
                        <i class="fas fa-trash"></i>
                        <span class="visually-hidden">Delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
          })
          .join("");
        registrationsTableBody.innerHTML = rowsHtml;
      };

      const makeApiCall = async (endpoint, options = {}) => {
        if (!ADMIN_SECRET_KEY) throw new Error("Not authenticated.");
        const headers = {
          "x-admin-key": ADMIN_SECRET_KEY,
          ...(options.body ? { "Content-Type": "application/json" } : {}),
          ...options.headers,
        };
        try {
          const response = await fetch(endpoint, { ...options, headers });
          const isJson = response.headers
            .get("content-type")
            ?.includes("application/json");
          const responseData = isJson ? await response.json() : null;

          if (!response.ok) {
            const errorMessage =
              responseData?.error || responseData?.message || `Request failed: ${response.status}`;
            throw new Error(errorMessage);
          }

          return responseData;
        } catch (error) {
          throw new Error(error.message || "A network error occurred.");
        }
      };

      const loadRegistrations = async (page = 1, options = {}) => {
        const { showButtonLoading = false } = options;
        if (showButtonLoading && refreshTableBtn) {
          setButtonLoading(refreshTableBtn, true);
        }
        setTableLoading(true);
        if (registrationsErrorEl) {
          registrationsErrorEl.classList.add("d-none");
        }
        try {
          const params = new URLSearchParams({
            page: String(page),
            limit: String(state.pageSize),
          });
          if (state.searchTerm) {
            params.set("search", state.searchTerm);
          }
          const data = await makeApiCall(
            `/.netlify/functions/list-registrations?${params.toString()}`,
          );
          const {
            results = [],
            total = 0,
            page: resolvedPage = 1,
            pageSize: resolvedPageSize = state.pageSize,
            totalPages: resolvedTotalPages = 1,
          } = data || {};

          state.totalRecords = total;
          state.pageSize = resolvedPageSize;
          state.currentPage = resolvedPage;
          state.totalPages = Math.max(1, resolvedTotalPages);
          state.currentRecords = Array.isArray(results) ? results : [];

          if (
            pageSizeSelect &&
            Number(pageSizeSelect.value) !== Number(state.pageSize)
          ) {
            pageSizeSelect.value = String(state.pageSize);
          }

          renderRegistrations(state.currentRecords);
          updatePaginationUI();
          updateLastRefreshLabel();
        } catch (error) {
          console.error("Registrations fetch error:", error);
          state.currentRecords = [];
          renderRegistrations([]);
          if (registrationsErrorEl) {
            registrationsErrorEl.textContent = `Unable to load registrations: ${error.message}`;
            registrationsErrorEl.classList.remove("d-none");
          }
        } finally {
          setTableLoading(false);
          if (showButtonLoading && refreshTableBtn) {
            setButtonLoading(refreshTableBtn, false);
          }
        }
      };

      const fetchDashboardStats = async () => {
        try {
          const data = await makeApiCall("/.netlify/functions/get-stats");
          if (totalRegCountEl)
            totalRegCountEl.textContent = Number(
              data.totalRegistrations || 0,
            ).toLocaleString("en-IN");
          if (registrationsLast24HoursEl)
            registrationsLast24HoursEl.textContent = Number(
              data.registrationsLast24Hours || 0,
            ).toLocaleString("en-IN");
          if (lastRegTimeEl)
            lastRegTimeEl.textContent = data.lastRegistrationTime
              ? formatDateTime(data.lastRegistrationTime)
              : "N/A";
          if (checkedInCountEl)
            checkedInCountEl.textContent = Number(
              data.totalCheckedIn || 0,
            ).toLocaleString("en-IN");
        } catch (err) {
          console.error("Stats fetch error:", err);
          if (totalRegCountEl) totalRegCountEl.textContent = "Error";
          if (registrationsLast24HoursEl)
            registrationsLast24HoursEl.textContent = "Error";
          if (lastRegTimeEl) lastRegTimeEl.textContent = "Error";
          if (checkedInCountEl) checkedInCountEl.textContent = "Error";
        }
      };

      const checkSystemStatus = async () => {
        ["database", "cloudinary", "googleSheets"].forEach((id) => {
          const el = document.getElementById(`status-${id}`);
          if (el) {
            el.innerHTML =
              '<div class="spinner-border spinner-border-sm"></div>';
          }
        });
        try {
          const statuses = await makeApiCall(
            "/.netlify/functions/check-status",
          );
          setStatusIndicator("status-database", statuses.database.status);
          setStatusIndicator("status-cloudinary", statuses.cloudinary.status);
          setStatusIndicator(
            "status-googleSheets",
            statuses.googleSheets.status,
          );
        } catch (err) {
          ["database", "cloudinary", "googleSheets"].forEach((id) =>
            setStatusIndicator(`status-${id}`, "error"),
          );
          console.error("Status check error:", err);
        }
      };

      const handleExport = async () => {
        setButtonLoading(exportBtn, true);
        if (exportStatus) {
          exportStatus.textContent = "Preparing download...";
        }
        try {
          const result = await makeApiCall("/.netlify/functions/export-data");
          window.open(result.downloadUrl, "_blank");
          if (exportStatus) exportStatus.textContent = "Download started!";
          const now = new Date();
          localStorage.setItem("lastExportTimestamp", now.toISOString());
          displayLastExportTime();
        } catch (err) {
          if (exportStatus)
            exportStatus.textContent = `Failed: ${err.message}`;
        } finally {
          setButtonLoading(exportBtn, false);
        }
      };

      const handleSyncSheets = async () => {
        setButtonLoading(syncSheetsBtn, true);
        if (syncStatus) {
          syncStatus.classList.remove("text-success", "text-danger");
          syncStatus.classList.add("text-muted");
          syncStatus.textContent = "Syncing with Google Sheets...";
        }
        try {
          const result = await makeApiCall(
            "/.netlify/functions/sync-with-google-sheets",
            { method: "POST" },
          );
          if (syncStatus) {
            const updatedCount = Number(result?.updated || 0);
            const appendedCount = Number(result?.appended || 0);
            syncStatus.classList.remove("text-muted", "text-danger");
            syncStatus.classList.add("text-success");
            syncStatus.textContent = `Sync complete: ${updatedCount} updated, ${appendedCount} added.`;
          }
        } catch (err) {
          if (syncStatus) {
            syncStatus.classList.remove("text-muted", "text-success");
            syncStatus.classList.add("text-danger");
            syncStatus.textContent = `Sync failed: ${err.message}`;
          }
        } finally {
          setButtonLoading(syncSheetsBtn, false);
        }
      };

      const handleLogout = () => {
        ADMIN_SECRET_KEY = null;
        state.currentPage = 1;
        state.totalPages = 1;
        state.totalRecords = 0;
        state.pageSize = DEFAULT_PAGE_SIZE;
        state.searchTerm = "";
        state.currentRecords = [];
        dashboardContainer.classList.add("d-none");
        loginContainer.classList.remove("d-none");
        loginForm.reset();
        clearFeedbackMessage();
        if (exportStatus) exportStatus.textContent = "";
        if (syncStatus) {
          syncStatus.textContent = "";
          syncStatus.classList.remove("text-success", "text-danger");
          syncStatus.classList.add("text-muted");
        }
        passwordInput.focus();
        setButtonLoading(loginBtn, false);
      };

      const handleSearchSubmit = (event) => {
        event.preventDefault();
        if (!registrationsSearchInput) return;
        state.searchTerm = registrationsSearchInput.value.trim();
        state.currentPage = 1;
        clearFeedbackMessage();
        loadRegistrations(1);
        syncSearchUI();
      };

      const handleClearSearch = () => {
        if (!registrationsSearchInput) return;
        registrationsSearchInput.value = "";
        if (!state.searchTerm) {
          syncSearchUI();
          return;
        }
        state.searchTerm = "";
        state.currentPage = 1;
        clearFeedbackMessage();
        loadRegistrations(1);
        syncSearchUI();
      };

      const getRecordByRegistrationId = (registrationId) =>
        state.currentRecords.find(
          (record) => record.registration_id === registrationId,
        );

      const openEditModal = (record) => {
        if (!editModalInstance || !record) return;
        if (editRegistrationForm) {
          editRegistrationForm.reset();
        }
        editRegistrationId.value = record.registration_id || "";
        editNameInput.value = record.name || "";
        editPhoneInput.value = record.phone || "";
        editEmailInput.value = record.email || "";
        editCityInput.value = record.city || "";
        editStateInput.value = record.state || "";
        editModalInstance.show();
      };

      const openDeleteModal = (record) => {
        if (!deleteModalInstance || !record) return;
        deleteRegistrationId.value = record.registration_id || "";
        deleteRegistrationSummary.textContent = `Remove ${record.name || "this registration"
          } (Reg ID: ${record.registration_id})? This cannot be undone.`;
        deleteModalInstance.show();
      };

      const handleEditSubmit = async (event) => {
        event.preventDefault();
        if (!editRegistrationSubmitBtn) return;
        setButtonLoading(editRegistrationSubmitBtn, true);
        clearFeedbackMessage();
        try {
          const normalizeField = (value) => {
            if (typeof value !== "string") return value;
            const trimmed = value.trim();
            return trimmed.length === 0 ? null : trimmed;
          };

          const payload = {
            registrationId: editRegistrationId.value,
            name: normalizeField(editNameInput.value),
            phone: normalizeField(editPhoneInput.value),
            email: normalizeField(editEmailInput.value),
            city: normalizeField(editCityInput.value),
            state: normalizeField(editStateInput.value),
          };

          await makeApiCall("/.netlify/functions/update-registration", {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          editModalInstance.hide();
          setFeedbackMessage("success", "Registration updated successfully.");
          await loadRegistrations(state.currentPage);
        } catch (error) {
          setFeedbackMessage("danger", `Unable to update registration: ${error.message}`);
        } finally {
          setButtonLoading(editRegistrationSubmitBtn, false);
        }
      };

      const handleDeleteConfirm = async (event) => {
        event.preventDefault();
        if (!confirmDeleteBtn) return;
        setButtonLoading(confirmDeleteBtn, true);
        clearFeedbackMessage();
        try {
          await makeApiCall("/.netlify/functions/delete-registration", {
            method: "DELETE",
            body: JSON.stringify({ registrationId: deleteRegistrationId.value }),
          });
          deleteModalInstance.hide();
          setFeedbackMessage("success", "Registration deleted successfully.");
          if (state.currentRecords.length <= 1 && state.currentPage > 1) {
            state.currentPage -= 1;
          }
          await loadRegistrations(state.currentPage);
        } catch (error) {
          setFeedbackMessage("danger", `Unable to delete registration: ${error.message}`);
        } finally {
          setButtonLoading(confirmDeleteBtn, false);
        }
      };

      const handleTableClick = (event) => {
        const actionBtn = event.target.closest("[data-action]");
        if (!actionBtn) return;
        const { action, registration: registrationId } = actionBtn.dataset;
        if (!registrationId) return;
        const record = getRecordByRegistrationId(registrationId);
        if (!record) return;
        if (action === "edit-registration") {
          openEditModal(record);
        } else if (action === "delete-registration") {
          openDeleteModal(record);
        }
      };

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        setButtonLoading(loginBtn, true);
        loginError.classList.add("d-none");
        try {
          const response = await fetch("/.netlify/functions/admin-login", {
            method: "POST",
            body: JSON.stringify({ password: passwordInput.value }),
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.error);

          ADMIN_SECRET_KEY = result.secretKey;
          loginContainer.classList.add("d-none");
          dashboardContainer.classList.remove("d-none");
          initializeDashboard();
        } catch (err) {
          loginError.textContent = err.message;
          loginError.classList.remove("d-none");
          setButtonLoading(loginBtn, false);
        }
      });

      function initializeDashboard() {
        totalRegCountEl = document.getElementById("totalRegCount");
        registrationsLast24HoursEl = document.getElementById(
          "registrationsLast24Hours",
        );
        lastRegTimeEl = document.getElementById("lastRegTime");
        checkedInCountEl = document.getElementById("checkedInCount");
        exportBtn = document.getElementById("exportBtn");
        exportStatus = document.getElementById("exportStatus");
        syncSheetsBtn = document.getElementById("syncSheetsBtn");
        syncStatus = document.getElementById("syncStatus");
        checkStatusBtn = document.getElementById("checkStatusBtn");
        lastExportTimeEl = document.getElementById("lastExportTime");
        pageSizeSelect = document.getElementById("pageSizeSelect");
        registrationsLoadingOverlay = document.getElementById(
          "registrationsLoading",
        );
        registrationsTableBody = document.getElementById(
          "registrationsTableBody",
        );
        registrationsErrorEl = document.getElementById("registrationsError");
        registrationsFeedbackEl = document.getElementById(
          "registrationsFeedback",
        );
        paginationStatusEl = document.getElementById("paginationStatus");
        paginationIndicatorEl = document.getElementById(
          "paginationIndicator",
        );
        paginationPrevBtn = document.getElementById("paginationPrev");
        paginationNextBtn = document.getElementById("paginationNext");
        refreshTableBtn = document.getElementById("refreshTableBtn");
        registrationsSearchForm = document.getElementById(
          "registrationsSearchForm",
        );
        registrationsSearchInput = document.getElementById(
          "registrationsSearchInput",
        );
        clearSearchBtn = document.getElementById("clearSearchBtn");
        editRegistrationForm = document.getElementById("editRegistrationForm");
        editRegistrationId = document.getElementById("editRegistrationId");
        editNameInput = document.getElementById("editNameInput");
        editPhoneInput = document.getElementById("editPhoneInput");
        editEmailInput = document.getElementById("editEmailInput");
        editCityInput = document.getElementById("editCityInput");
        editStateInput = document.getElementById("editStateInput");
        editRegistrationSubmitBtn = document.getElementById(
          "editRegistrationSubmitBtn",
        );
        deleteRegistrationForm = document.getElementById(
          "deleteRegistrationForm",
        );
        deleteRegistrationId = document.getElementById(
          "deleteRegistrationId",
        );
        deleteRegistrationSummary = document.getElementById(
          "deleteRegistrationSummary",
        );
        confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

        if (window.bootstrap) {
          const editModalEl = document.getElementById("editRegistrationModal");
          const deleteModalEl = document.getElementById("deleteRegistrationModal");
          if (editModalEl) {
            editModalInstance = new bootstrap.Modal(editModalEl);
            editModalEl.addEventListener("hidden.bs.modal", () => {
              editRegistrationForm?.reset();
            });
          }
          if (deleteModalEl) {
            deleteModalInstance = new bootstrap.Modal(deleteModalEl);
            deleteModalEl.addEventListener("hidden.bs.modal", () => {
              deleteRegistrationForm?.reset();
            });
          }
        }

        state.pageSize = Number(pageSizeSelect?.value) || DEFAULT_PAGE_SIZE;
        syncSearchUI();

        if (checkStatusBtn) {
          checkStatusBtn.addEventListener("click", checkSystemStatus);
        }
        if (exportBtn) {
          exportBtn.addEventListener("click", handleExport);
        }
        if (syncSheetsBtn) {
          syncSheetsBtn.addEventListener("click", handleSyncSheets);
        }
        if (logoutBtn) {
          logoutBtn.addEventListener("click", handleLogout);
        }

        if (pageSizeSelect) {
          pageSizeSelect.addEventListener("change", () => {
            state.pageSize = Number(pageSizeSelect.value) || DEFAULT_PAGE_SIZE;
            state.currentPage = 1;
            loadRegistrations(1);
          });
        }

        if (paginationPrevBtn) {
          paginationPrevBtn.addEventListener("click", () => {
            if (state.currentPage > 1) {
              loadRegistrations(state.currentPage - 1);
            }
          });
        }

        if (paginationNextBtn) {
          paginationNextBtn.addEventListener("click", () => {
            if (state.currentPage < state.totalPages) {
              loadRegistrations(state.currentPage + 1);
            }
          });
        }

        if (refreshTableBtn) {
          refreshTableBtn.addEventListener("click", () => {
            loadRegistrations(state.currentPage, { showButtonLoading: true });
          });
        }

        if (registrationsSearchForm) {
          registrationsSearchForm.addEventListener("submit", handleSearchSubmit);
        }
        if (clearSearchBtn) {
          clearSearchBtn.addEventListener("click", handleClearSearch);
        }

        if (registrationsTableBody) {
          registrationsTableBody.addEventListener("click", handleTableClick);
        }

        if (editRegistrationForm) {
          editRegistrationForm.addEventListener("submit", handleEditSubmit);
        }

        if (deleteRegistrationForm) {
          deleteRegistrationForm.addEventListener("submit", handleDeleteConfirm);
        }

        if (refreshDashboardBtn) {
          refreshDashboardBtn.addEventListener("click", async () => {
            setButtonLoading(refreshDashboardBtn, true);
            try {
              await Promise.all([
                fetchDashboardStats(),
                loadRegistrations(state.currentPage),
                checkSystemStatus(),
              ]);
            } finally {
              setButtonLoading(refreshDashboardBtn, false);
            }
          });
        }

        fetchDashboardStats();
        checkSystemStatus();
        displayLastExportTime();
        loadRegistrations(state.currentPage);
        setButtonLoading(loginBtn, false);
      }
    });
  </script>
</body>

</html>