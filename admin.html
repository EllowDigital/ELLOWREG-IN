<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Tent Decor Expo UP 2025</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css"
        integrity="sha512-fw7f+TcMjTb7bpbLJZlP8g2Y4XcCyFZW8uy8HsRZsH/SwbMw0plKHFHr99DN3l04VsYNwvzicUX/6qurvIxbxw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
        integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 800px;
        }

        .card {
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #0A2540;
            color: white;
            font-weight: 600;
        }

        #searchResult .card {
            background-color: #fff;
        }

        #searchResult img {
            max-width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #0A2540;
            border-color: #0A2540;
        }

        .btn-primary:hover {
            background-color: #3c6e9e;
            border-color: #3c6e9e;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="text-center mb-4">
            <h1 class="display-5">Admin Dashboard</h1>
            <p class="lead text-muted">Tent Decor Expo UP 2025</p>
        </div>

        <!-- Hidden Secret Key Input -->
        <input type="password" class="form-control d-none" id="secretKey" value="TDEXPOUP2025">

        <!-- Search Panel -->
        <div class="card mb-4">
            <h5 class="card-header">Find a Registration</h5>
            <div class="card-body">
                <div class="input-group">
                    <span class="input-group-text">+91</span>
                    <input type="tel" class="form-control" id="phoneInput" placeholder="10-digit phone number"
                        maxlength="10">
                    <button id="searchBtn" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="button-text">Search</span>
                    </button>
                </div>
                <div id="searchStatus" class="mt-3"></div>
                <div id="searchResult" class="mt-4 d-none"></div>
            </div>
        </div>

        <!-- Export Panel -->
        <div class="card">
            <h5 class="card-header">Export All Data</h5>
            <div class="card-body">
                <p class="card-text">Download the complete registration list as an Excel file. Data is also synced to
                    Google Sheets in real-time upon each successful registration.</p>
                <button id="exportBtn" class="btn btn-success btn-lg w-100">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <span class="button-text"><i class="fas fa-file-excel me-2"></i>Download as Excel (.xlsx)</span>
                </button>
                <div id="exportStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const secretKeyInput = document.getElementById('secretKey');
            secretKeyInput.value = 'TDEXPOUP2025'; // Ensure autofill

            const searchBtn = document.getElementById('searchBtn');
            const phoneInput = document.getElementById('phoneInput');
            const searchStatus = document.getElementById('searchStatus');
            const searchResult = document.getElementById('searchResult');

            function setButtonLoading(button, isLoading, text = 'Loading...') {
                const buttonText = button.querySelector('.button-text');
                const spinner = button.querySelector('.spinner-border');
                const originalText = button.dataset.originalText || buttonText.innerHTML;

                if (isLoading) {
                    if (!button.dataset.originalText) {
                        button.dataset.originalText = buttonText.innerHTML;
                    }
                    button.disabled = true;
                    buttonText.textContent = text;
                    spinner.classList.remove('d-none');
                } else {
                    button.disabled = false;
                    buttonText.innerHTML = originalText;
                    spinner.classList.add('d-none');
                }
            }

            function displayUser(data) {
                searchResult.classList.remove('d-none');
                searchStatus.className = 'd-none';
                searchStatus.textContent = '';

                const registrationDate = new Date(data.timestamp).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                searchResult.innerHTML = `
          <div class="card">
            <div class="card-body text-center">
              <img src="${data.image_url}" alt="Profile Photo" class="mb-3 img-thumbnail">
              <h3 class="card-title">${data.name}</h3>
              <h5 class="card-subtitle mb-2 text-muted">${data.company}</h5>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between"><strong>Registration ID:</strong> <span>${data.registration_id}</span></li>
              <li class="list-group-item d-flex justify-content-between"><strong>Phone:</strong> <span>+91 ${data.phone}</span></li>
              <li class="list-group-item d-flex justify-content-between"><strong>Address:</strong> <span>${data.address}, ${data.city}, ${data.state}</span></li>
              <li class="list-group-item d-flex justify-content-between"><strong>Attending:</strong> <span>${data.day}</span></li>
              <li class="list-group-item d-flex justify-content-between"><strong>Payment ID:</strong> <span>${data.payment_id}</span></li>
              <li class="list-group-item d-flex justify-content-between"><strong>Registered On:</strong> <span>${registrationDate}</span></li>
            </ul>
          </div>
        `;
            }

            searchBtn.addEventListener('click', async () => {
                const phone = phoneInput.value.trim();
                const secretKey = secretKeyInput.value.trim();

                if (!phone || !/^\d{10}$/.test(phone)) {
                    searchStatus.className = 'alert alert-warning';
                    searchStatus.textContent = 'Please enter a valid 10-digit phone number.';
                    return;
                }

                setButtonLoading(searchBtn, true, 'Searching...');
                searchStatus.textContent = '';
                searchResult.classList.add('d-none');

                try {
                    const response = await fetch(`/.netlify/functions/search-user?phone=${phone}`, {
                        headers: { 'x-admin-key': secretKey }
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        searchStatus.className = 'alert alert-warning';
                        searchStatus.textContent = result.error || 'User not found.';
                        return;
                    }

                    displayUser(result);
                } catch (error) {
                    searchStatus.className = 'alert alert-danger';
                    searchStatus.textContent = 'An error occurred. Please check the console.';
                    console.error('Search failed:', error);
                } finally {
                    setButtonLoading(searchBtn, false);
                }
            });

            const exportBtn = document.getElementById('exportBtn');
            const exportStatus = document.getElementById('exportStatus');

            exportBtn.addEventListener('click', async () => {
                const secretKey = secretKeyInput.value.trim();

                setButtonLoading(exportBtn, true, 'Exporting...');
                exportStatus.textContent = '';
                exportStatus.className = '';

                try {
                    const response = await fetch('/.netlify/functions/export-data', {
                        headers: { 'x-admin-key': secretKey }
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(`Server responded with ${response.status}: ${errorData}`);
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    const disposition = response.headers.get('content-disposition');
                    let filename = `registrations_${new Date().toISOString()}.xlsx`;
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(disposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    exportStatus.className = 'alert alert-success';
                    exportStatus.textContent = 'Export successful! Check your downloads and Google Sheet.';
                } catch (error) {
                    exportStatus.className = 'alert alert-danger';
                    exportStatus.textContent = 'Export failed. Please check the console for errors.';
                    console.error('Export failed:', error);
                } finally {
                    setButtonLoading(exportBtn, false);
                }
            });
        });
    </script>
</body>

</html>